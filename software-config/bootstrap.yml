---
- hosts: jupyterhosts
  roles:
    - stdazurevm
  tasks:
    - name: Microsoft yum repo
      yum_repository:
        name: microsoft
        description: Microsoft rpm repo
        baseurl: https://packages.microsoft.com/rhel/8/prod/
    - name: Microsoft rpm signing key
      command:
        cmd: rpm --import http://packages.microsoft.com/keys/microsoft.asc
    - name: update kernel
      yum:
        name: kernel
        state: latest
      notify:
        - Reboot system
    - name: Update system
      yum:
        name: "*"
        state: latest
    - name: set timezone to Europe/Oslo
      timezone:
        name: Europe/Oslo
    - name: set hostname in hosts
      lineinfile:
        path: /etc/hosts
        regexp: '^(127\.0\.0\.1) +(localhost.*)'
        line: \g<1> {{ ansible_hostname }} \g<2>
        backrefs: yes
    - name: upload defender onboarding file
      copy:
        dest: /etc/opt/microsoft/mdatp/
        src: mdatp_onboard.json
        mode: 0644
    - name: Install defender
      dnf:
        name: mdatp
        state: present
    - name: enable defender service
      systemd:
        name: mdatp
        enabled: yes
        state: started
  handlers:
    - name: Reboot system
      reboot:
